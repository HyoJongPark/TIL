# CHAPTER 7 - 교착 상태

다중 프로그래밍 환경에서는 여러 스레드가 한정된 자원을 사용하려고 서로 경쟁할 수 있다.

한 스레드가 자원을 요청했을 때, 그 자원을 사용할 수 없는 상황이 발생할 수 있고, 그때는 스레드가 대기 상태로 들어간다. 이처럼 대기 중인 스레드들이 결코 다시는 그 상태를 변경시킬 수 없으면 이런 상황을 **교착 상태**라 부른다.

## 1. 시스템 모델_System Model

- **시스템**은 경쟁하는 스레드들 사이에 분배되어야 할 **유한한 수의 자원들로 구성**된다.
- 이 **자원**들은 다수의 유형 또는 클래스로 분할되며, 이들 각각은 **동등한 다수의 인스턴스들로 구성**된다.
    - 자원의 예: CPU 주기, 파일, 입/출력 장치 등
- 정상적인 작동 모드하에서, 프로세스는 다음 순서로만 자원을 사용할 수 있다.
    1. 요청
        - 스레드는 자원을 요청한다. 요청이 즉시 허용되지 않으면, 요청 스레드는 자원을 얻을 때 까지 대기해야 한다.
    2. 사용
        - 스레드는 자원에 대해 작업을 수행할 수 있다.
    3. 방출
        - 스레드가 자원을 방출한다.
    - 자원의 요청, 방출은 시스템 콜이다.(`request()`, `release()` 등)
- 한 스레드 집합 내의 모든 스레드가 그 집합 내의 다른 스레드에 의해서만 발생될 수 있는 이벤트를 기다린다면, 그 스레드 집합은 **교착 상태에 있다.**

---

## 2. 다중 스레드 응용에서의 교착 상태_Deadlock in Multithreaded Applications

### 2.1 라이브락_Livelock

- 라이브락(livelock)은 또 다른 형태의 라이브니스 장애다.
- 두개 이상의 스레드가 진행되는 것을 방해한다는 점에서 교착 상태와 유사하지만 진행할 수 없는 이유가 서로 다르다.
- 교착 상태는 어떤 스레드가 같은 집합에 속한 다른 스레드에 의해서만 발생할 수 있는 이벤트를 기다리면서 봉쇄되면 발생
- 라이브락은 스레드가 실패한 행동을 계속해서 시도할 때 발생한다.

---

## 3. 교착 상태 특성_Deadlock Characterization

### 3.1 필요조건들_Necessary Conditions

- 교착 상태는 한 시스템에 다음 네 가지 조건들이 동시에 성립될 때 발생할 수 있다.
1. 상호 배제(mutual exclusion)
    - 최소 하나의 자원이 비공유 모드로 점유되어야 한다.
    - 비공유 모드에서는 한 번에 한 스레드만이 그 자원을 사용할 수 있다.
    - 다른 스레드가 그 자원을 요청하면, 요청 스레드는 자원이 방출될 때까지 반드시 지연되어야 한다.
2. 점유하며 대기(hold-and-wait)
    - 스레드는 최소한 하나의 자원을 점유한 채, 현재 다른 스레드에 의해 점유된 자원을 추가로 얻기 위해 반드시 대기해야 한다.
3. 비선점(no preemption)
    - 자원들을 선점할 수 없어야 한다.
    - 자원이 강제적으로 방출될 수 없고, 점유하고 있는 스레드가 태스크를 종료한 후 그 스레드에 의해 자발적으로만 방출될 수 있다.
4. 순환 대기(circular wait)
    - 대기하고 있는 스레드 집합[T0, T1, … , Tn]에서는 T0는 T1이 점유한 자원을 대기하고, T1은 T2가 점유한 자원을 대기한다. (순환 대기)

### 3.2 자원 할당 그래프_Resource-Allocation Graph

![Untitled](https://user-images.githubusercontent.com/75190035/175801377-45c9cf1b-9679-4a98-93c0-10462404346e.png)

- 교착 상태는 시스템 자원 할당 그래프라고 하는 방향 그래프로 더욱 정확하게 기술될 수 있다.
- 이 그래프는 정점(vertex) V의 집합, 간선(edge) E의 집합으로 구성된다.
- 정점 V의 집합은 시스템 내 모든 활성 스레드 집합인 T = {T1, T2, …, Tn}과 시스템 내 모든 자원 유형의 집합인 R = {R1, R2, …, Rn}의 두 가지 유형으로 구별된다.
- **표현 방법**
    - **요청 간선(request edge)**
        - 스레드 Ti로부터 자원 유형 Rj로의 방향 간선은 Ti → Rj로 표현하며, 이것은 **스레드가 자원 유형의 인스턴스를 하나 요청**하는 것으로 현재 이 자원을 기다리는 상태다.
    - **할당 간선(request edge)**
        - 자원 유형 Rj부터 스레드 Ti로의 방향 간선은 Rj → Ti로 표현하며, 이것은 자원 유형의 한 인스턴스가 스레드에 할당된 것을 의미한다.
    - 각 스레드를 원으로 표현하고, 각 자원 유형을 사각형으로 표시한다.
    - 각 자원 유형이 가지는 인스턴스의 수를 사각형 안의 점으로 표시한다.

**자원 할당 그래프 예시 1**

![Untitled 1](https://user-images.githubusercontent.com/75190035/175801391-60746c15-482b-469c-90cb-2be915692b9f.png)

위 그림의 자원 할당 그래프는 다음 상황을 묘사한다.

- 집합 T, R, E
    - T = {T1, T2, T3}
    - R = {R1, R2, R3, R4}
    - E = {T1 → R1, T2 → R3, R1 → T2, R2 → T2, R3 → T3}
- 자원의 인스턴스
    - 자원 유형 R1의 인스턴스가 한 개
    - 자원 유형 R2의 인스턴스가 두 개
    - 자원 유형 R3의 인스턴스가 한 개
    - 자원 유형 R4의 인스턴스가 세 개
- 스레드 상태
    - 스레드 T1은 자원유형 R2의 인스턴스 한 개를 점유하고, 자원 유형 R1의 인스턴스 한 개를 기다리며 대기한다.
    - 스레드 T2는 R1, R2의 인스턴스를 각각 한 개씩 점유하고, 자원 유형 R3의 인스턴스를 한 개 기다린다.
    - 스레드 T3는 R3의 인스턴스 한 개를 점유하고 있다.
- 교착 상태 여부
    - 만약 각 자원 유형이 하나의 인스턴스만 가지면, 그래프 내의 한 사이클은 교착 상태가 존재하기 위한 필요 충분 조건이 된다.
    - 만약 각 자원 유형이 하나 이상의 인스턴스만 가지면, 그래프 내의 한 사이클은 교착 상태가 존재하기 위한 필요조건이지만, 충분 조건이 되지는 않는다.
    - 위 그래프에서는 스레드 T3가 어떠한 자원 유형도 점유하지 않기 때문에 **점유하며 대기**조건에 맞지 않는다. 따라서 교착 상태가 아니다.

**자원 할당 그래프 예시 2**

![Untitled 2](https://user-images.githubusercontent.com/75190035/175801395-4323ae10-b513-4120-8569-67796c9d8788.png)

예시1에서 T3 → R2 요청간선이 추가되어 이 시스템 내에 최소 2개의 사이클이 존재하게 되었다.

- T1 → R1 → T2 → R3 → T3 → R2 → T1 → T2 → R3 → T3 → R2 → T2
- 교착 상태 여부
    - 스레드 T1, T2, T3는 교착 상태다.
    - 스레드 T1는 스레드 T2가 점유하고 있는 자원 R1을 기다린다.
    - 스레드 T2는 스레드 T3가 점유하고 있는 자원 R3을 기다린다.
    - 스레드 T3는 스레드 T1, T3가 점유하고 있는 자원 R2을 기다린다.

**자원 할당 그래프 예시 3**

![Untitled 3](https://user-images.githubusercontent.com/75190035/175801397-dd3b29ef-bbab-4754-a58c-7767b370cfde.png)

예시 3도 사이클을 갖는다.

- T1 → R1 → T3 → R2 → T1
- 교착 상태 여부
    - 위 예시는 교착 상태가 없다.
    - 프로세스 T4가 자원유형 R2의 인스턴스를 방출할 수 있다.
    - 이어 T3가 할당될 수 있고 그 경우 사이클이 없어진다.

요약하면, **자원 할당 그래프에 사이클이 없다면, 시스템을 교착상태가 아니다.**

반면, **사이클이 있다면 시스템은 교착 상태일 수도, 아닐 수도 있다.**

> 참고
> 
> - 책
> 
> [⌜Operating System Concepts 10th - Abraham Silberschatz, Peter B. Galvin, Greg Gagne⌟](http://www.yes24.com/Product/Goods/78225791)
> 
> - 블로그
> 
> [https://suhwanc.tistory.com/181?category=879656](https://suhwanc.tistory.com/181?category=879656)
> 
> [https://will-behappy.tistory.com/23?category=808600](https://will-behappy.tistory.com/23?category=808600)
>
